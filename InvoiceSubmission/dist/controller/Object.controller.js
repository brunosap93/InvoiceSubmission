sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","../model/formatter","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,i,r,a,s){"use strict";var o=0;var n=0;var c=100;return e.extend("ns.InvoiceSubmission.controller.Object",{formatter:r,onInit:function(){var e=new t({busy:true,delay:0,PO:false});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"objectView")},_loadPurchaseOrders:function(){var e=this;this._result=[];var t=this.getResourceBundle();var i=false;sap.ui.core.BusyIndicator.show(0);$.ajax({type:"GET",url:"/nsInvoiceSubmission/ProcurementService/browse/PurchaseOrder?$filter=Status eq 'Pending' and Supplier eq 'USSU-VSF63'&$expand=To_PurchaseOrderItems($orderby=PurchaseOrderItem asc;$filter=Status eq 'Pending')",cache:false,dataType:"json",async:false,error:function(r,a){sap.ui.core.BusyIndicator.hide();i=false;var s=t.getText("msnDataBaseError");e._addMessageManager(s)},success:function(t){sap.ui.core.BusyIndicator.hide();e._result=t;i=true}});var r=e._result;return r},onSubmitInvoice:function(){var e=this.getView().byId("switchPO").getState();var t=this;sap.ui.core.BusyIndicator.show(0);if(e){var i=JSON.stringify({RuleServiceId:"6a832a7ae8c440eab3ab698cca900350",Vocabulary:[{PoInvoiceDifference:{Percentage:c,Amount:0,BusinessPartnerName:this.getView().getBindingContext().getObject("SupplierName")}}]});$.ajax({type:"POST",url:"/nsInvoiceSubmission/BUSINESS_RULES/rules-service/rest/v2/workingset-rule-services",cache:false,dataType:"json",headers:{"Content-Type":"application/json"},data:i,async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("An error has occured. Status: "+t)},success:function(e){t.onAfterCheck(e.Result[0].CloseInvoice.Status)}})}else{var r=!!this.getView().$().closest(".sapUiSizeCompact").length;s.confirm("This invoice doesn't have a PO and it will go through an internal approval process, are you sure you want to continue?",{styleClass:r?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK"){var i=t.byId("table").getBindingContext().sPath.split("'")[1];var r=JSON.stringify({definitionId:"approvalinvoicestory",context:{type:"nonpo",invoiceNumber:i}});t.triggerWorkflow(r);a.show("Invoice without PO sent for approval")}else{sap.ui.core.BusyIndicator.hide()}}})}},onAfterCheck:function(e){var t=this;if(e=="Error"){var i=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.ui.core.BusyIndicator.hide();s.error("The net amount difference variance the selected invoice and the purchae order items is too high. ",{styleClass:i?"sapUiSizeCompact":""})}else if(e=="Approval"){var i=!!this.getView().$().closest(".sapUiSizeCompact").length;s.warning("The net amount difference between the selected invoice and the purchae order items is above the allowed threshold and it will require to be approved by "+"our purchasing department, do you want to continue?",{actions:[s.Action.OK,s.Action.CANCEL],styleClass:i?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK"){var i=t.byId("table").getBindingContext().sPath.split("'")[1];var r=t.byId("treeTable");var s=r.getSelectedIndices();var o=[];for(var n=0;n<s.length;n++){var c=r.getContextByIndex(s[n]);if(c!=undefined){var u=String(c.sPath);if(u.indexOf("To_PurchaseOrderItems")>0){o.push(String(c.getObject().ID))}}}var d=JSON.stringify({definitionId:"approvalinvoicestory",context:{type:"po",invoiceNumber:i,PONumber:c.getObject("DocNumber_DocNumber"),POitems:o}});t.triggerWorkflow(d);a.show("Invoice without PO sent for approval")}else{sap.ui.core.BusyIndicator.hide()}}})}else if(e=="Approved"){s.warning("There is a variance between the invoce and the purchase order net amounts, "+"do you want to continue?",{actions:[s.Action.OK,s.Action.CANCEL],styleClass:i?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK"){t.updateRecords("Done")}else{sap.ui.core.BusyIndicator.hide()}}})}else if(e=="Success"){s.confirm("This invoice will be received, are you sure you want to continue?",{styleClass:i?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK")t.updateRecords("Done");else{sap.ui.core.BusyIndicator.hide()}}})}else{a.show("Something went wrong")}},updateRecords:function(e){var t=this.getView().byId("treeTable").getSelectedIndices();var i="";this.getView().byId("invoiceStatus").setText(e);for(var r=0;r<t.length;r++){i=this.getView().byId("treeTable").getContextByIndex(t[r]).getObject().ID;this.closeItems(i,e)}sap.ui.core.BusyIndicator.hide();this.onNavBack()},closeItems:function(e,t){var i=JSON.stringify({Status:t});$.ajax({type:"PATCH",url:"/ProcurementService/browse/PurchaseOrderItems("+e+")",cache:false,dataType:"json",headers:{"Content-Type":"application/json"},data:i,async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("An error has occured. Status: "+t)},success:function(e){sap.ui.core.BusyIndicator.hide()}})},triggerWorkflow:function(e){var t=this;$.ajax({type:"POST",url:"/nsInvoiceSubmission/workflowService/workflow-service/rest/v1/workflow-instances",cache:false,dataType:"json",headers:{"Content-Type":"application/json"},data:e,async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("An error has occured. Status: "+t)},success:function(e){t.updateRecords("Approving");a.show("Approval process has been initiated")}})},onSwitchChange:function(e){var t=this.getModel("objectView");t.setProperty("/PO",e.getParameter("state"))},oRowSelection:function(e){var t=e.getSource().getSelectedIndex();var i=e.getSource().getContextByIndex(e.getSource().getSelectedIndex());if(i!=undefined){var r=String(i.sPath);if(r.indexOf("To_PurchaseOrderItems")<0){var a=r.substring(7);var s=parseInt(a);var c=this.getView().byId("treeTable").getModel().getData().value[s].To_PurchaseOrderItems.length;this.getView().byId("treeTable").addSelectionInterval(t+1,t+c)}}var u=e.getSource().getSelectedIndices();var d;var l=0;for(var h=0;h<u.length;h++){var i=e.getSource().getContextByIndex(u[h]);if(i!=undefined){var r=String(i.sPath);var g=parseInt(r.split("/")[2]);var p=parseInt(r.split("/")[4]);var v=this.getView().byId("treeTable").getModel().getData().value[g].To_PurchaseOrderItems[p];if(v!=undefined){d=v.NetPriceAmount;l+=d}}}o=n-l;this.updateNumber(o)},updateNumber:function(e){this.getView().byId("difAmount").setValue(e);if(e<0)this.getView().byId("difAmount").setIndicator("Up");else if(e>0)this.getView().byId("difAmount").setIndicator("Down");else this.getView().byId("difAmount").setIndicator("None");c=e*100/n;if(c>50||c<-50)this.getView().byId("difAmount").setValueColor("Error");else if(c>0||c<0)this.getView().byId("difAmount").setValueColor("Critical");else this.getView().byId("difAmount").setValueColor("Good")},onNavBack:function(){var e=Math.max.apply(Math,this.getView().byId("treeTable").getSelectedIndices());var t=this.getModel("objectView");this.getView().byId("treeTable").removeSelectionInterval(0,e);t.setProperty("/PO",false);this.getOwnerComponent().getRouter().navTo("worklist",{})},onShareInJamPress:function(){var e=this.getModel("objectView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},_onObjectMatched:function(e){var i=e.getParameter("arguments").objectId;this._bindView("/Invoice"+i);var r=this.byId("treeTable");var a=this._loadPurchaseOrders();var s=new t(a);r.setModel(s);r.bindRows({path:"/value",sorter:{path:"PurchaseOrderItem",descending:true},filters:[{path:"Status",operator:"EQ",value1:"Pending"}],parameters:{expand:"To_PurchaseOrderItems",navigation:{value:"To_PurchaseOrderItems"}}})},_bindView:function(e){var t=this.getModel("objectView");var i=this;this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),i=e.getElementBinding();if(!i.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var r=this.getResourceBundle();var a=this;e.getBindingContext().requestObject().then(function(e){var i=e.DocNumber,s=e.SupplierName;n=parseFloat(e.NetPriceAmount);a.updateNumber(n);this.addHistoryEntry({title:this.getResourceBundle().getText("objectTitle")+" - "+s,icon:"sap-icon://enter-more",intent:"#InvoiceSubmission-display&/Invoice("+i+")"});t.setProperty("/busy",false);t.setProperty("/saveAsTileTitle",r.getText("saveAsTileTitle",[s]));t.setProperty("/shareOnJamTitle",s);t.setProperty("/shareSendEmailSubject",r.getText("shareSendEmailObjectSubject",[i]));t.setProperty("/shareSendEmailMessage",r.getText("shareSendEmailObjectMessage",[s,i,location.href]))}.bind(this))}})});