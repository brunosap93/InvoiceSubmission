sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment"],function(e,t,i,n,o){"use strict";var r=null;var a=0;var s;var c;return e.extend("ns.InvoiceSubmission.controller.Create",{onInit:function(){this._wizard=this.byId("CreateInvoiceWizard");this._oNavContainer=this.byId("wizardNavContainer");this._oWizardContentPage=this.byId("wizardContentPage");o.load({name:"ns.InvoiceSubmission.view.ReviewPage",controller:this}).then(function(e){this._oWizardReviewPage=e;this._oNavContainer.addPage(this._oWizardReviewPage)}.bind(this));var e=new t;e.setData({invoiceState:"None",companyState:"None",documentState:"None",amountState:"None",currencyState:"None",pdfView:false});this.getView().setModel(e,"objectView");var i=new t;i.setData({disValue:"0%",value:"0",visible:false});this.getView().setModel(i,"progressBar");this.modelForm=new t;this.modelForm.setData({DocNumber:"",SupplierName:"",DocumentDate:"",NetPriceAmount:null,DocumentCurrency:"",To_InvoiceItems:[{InvoiceItem:"",Material:"",Description:"",InvoiceQuantity:null,UnitPrice:null,NetPriceAmount:null}]});this.getView().setModel(this.modelForm)},onAfterRendering:function(){var e=this.createId("pdfViewer");var t=this.createId("previewInv");var i=this;document.getElementById(this.createId("file")).addEventListener("change",function(){if(this.files&&this.files[0]){c=this.files[0];sap.ui.core.BusyIndicator.show(0);var t=document.getElementById(e);var n=new FileReader;var o=this.files[0].type;var r=i.getView().getModel("progressBar");r.setProperty("/value","20");r.setProperty("/disValue","20%");r.setProperty("/visible",true);i.processPDF(this.files[0]);n.onload=function(e){s=e.target.result};n.readAsDataURL(this.files[0])}})},onSwitchChange:function(e){var t=e.getParameter("state");this.getView().getModel("objectView").setProperty("/pdfView",t);if(t){var i=this.createId("pdfViewer");var n=document.getElementById(i);n.data=s}debugger},onUploadInvoice:function(){var e=document.getElementById(this.createId("file"));e.click()},setProductType:function(e){var t=e.getSource().getTitle();this.model.setProperty("/productType",t);this.byId("ProductStepChosenType").setText("Chosen product type: "+t);this._wizard.validateStep(this.byId("InvoiceUploadStep"))},setProductTypeFromSegmented:function(e){var t=e.getParameters().item.getText();this.model.setProperty("/productType",t);this._wizard.validateStep(this.byId("InvoiceUploadStep"))},processPDF:function(e){var t=this;var i=new FormData;var n=this.getView().getModel("progressBar");i.append("options",'{\n  "extraction": {\n    "headerFields": [\n      "barcode",\n      "documentNumber",\n      "taxId",\n      "taxName",\n      "purchaseOrderNumber",\n      "shippingAmount",\n      "netAmount",\n      "grossAmount",\n      "currencyCode",\n      "receiverContact",\n      "documentDate",\n      "taxAmount",\n      "taxRate",\n      "receiverName",\n      "receiverAddress",\n      "receiverTaxId",\n      "deliveryDate",\n      "paymentTerms",\n      "deliveryNoteNumber",\n      "senderBankAccount",\n      "senderAddress",\n      "senderName",\n      "dueDate",\n      "discount"\n    ],\n    "lineItemFields": [\n      "description",\n      "netAmount",\n      "quantity",\n      "unitPrice",\n      "materialNumber",\n      "unitOfMeasure"\n    ]\n  },\n  "clientId": "default",\n  "documentType": "invoice",\n  "receivedDate": "2020-02-17",\n  "enrichment": {\n    "sender": {\n      "top": 5,\n      "type": "businessEntity",\n      "subtype": "supplier"\n    },\n    "employee": {\n      "type": "employee"\n    }\n  }\n}');i.append("file",e);var o=new XMLHttpRequest;o.withCredentials=true;o.addEventListener("readystatechange",function(){if(this.readyState===4){if(this.status==201){n.setProperty("/value","60");n.setProperty("/disValue","60%");n.setProperty("/visible",true);t.waitComplete(JSON.parse(this.response).id,0)}}});o.open("POST","/nsInvoiceSubmission/doxDest/document/jobs");o.send(i)},waitComplete:function(e,t){var n=false;var o=this;$.ajax({type:"GET",url:"/nsInvoiceSubmission/doxDest/document/jobs/"+e,cache:false,dataType:"json",async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();n=false},success:function(r){if(r.status!="DONE"){if(t>=50){sap.ui.core.BusyIndicator.hide();t=0;i.show("Docuemtn Information Extraction is taking too long, please try again.")}else{o.jumpWait(e,t)}}else{t=0;o.fillForm(r);sap.ui.core.BusyIndicator.hide()}n=true}})},jumpWait:async function(e,t){await new Promise(function(e){setTimeout(e,7500)});t++;this.waitComplete(e,t)},fillForm:function(e){var i=this.getView().getModel("progressBar");i.setProperty("/value","80");i.setProperty("/disValue","80%");i.setProperty("/visible",true);var n=this._createJsonDOX(e);var o=new t;o.setData(n);this.getView().setModel(o);i.setProperty("/value","100");i.setProperty("/disValue","100%");i.setProperty("/visible",true);this._wizard.validateStep(this.byId("InvoiceUploadStep"))},_createJsonDOX:function(e){var t=e.extraction.headerFields;var i=e.extraction.lineItems;var n={};var o={};var r=[];var a;for(var s=0;s<t.length;s++){if(t[s].name=="documentNumber")a="DocNumber";else if(t[s].name=="documentDate")a="DocumentDate";else if(t[s].name=="senderName")a="SupplierName";else if(t[s].name=="netAmount")a="NetPriceAmount";else if(t[s].name=="currencyCode")a="DocumentCurrency";else a="None";if(a!="None"){if(a=="NetPriceAmount")t[s].value=String(t[s].value);n[a]=t[s].value}}n["Status"]="Pending";for(var s=0;s<i.length;s++){var o={};o["InvoiceItem"]=s+1;for(var c=0;c<i[s].length;c++){if(i[s][c].name=="description")a="Description";else if(i[s][c].name=="materialNumber")a="Material";else if(i[s][c].name=="quantity")a="InvoiceQuantity";else if(i[s][c].name=="netAmount")a="NetPriceAmount";else if(i[s][c].name=="unitPrice")a="UnitPrice";else a="None";if(a!="None"){if(a=="NetPriceAmount"||a=="UnitPrice")i[s][c].value=String(i[s][c].value);o[a]=i[s][c].value}}o["Status"]="Pending";o["QuantityUnit"]="NA";r.push(o)}n["To_InvoiceItems"]=r;return n},additionalInfoValidation:function(){var e=this.byId("InvoiceNumber").getValue();var t=this.byId("CompanyName").getValue();var i=this.byId("DocumentDate").getValue();var n=this.byId("NetAmount").getValue();var o=this.byId("Currency").getValue();var r=this.getView().getModel("objectView");if(n.length<1){r.setProperty("/NetAmount","Error")}else{r.setProperty("/NetAmount","None")}if(e.length<1){r.setProperty("/InvoiceNumber","Error")}else{r.setProperty("/InvoiceNumber","None")}if(t.length<1){r.setProperty("/SupplierName","Error")}else{r.setProperty("/SupplierName","None")}if(i.length<1){r.setProperty("/DocumentDate","Error")}else{r.setProperty("/DocumentDate","None")}if(o.length<1){r.setProperty("/Currency","Error")}else{r.setProperty("/Currency","None")}if(e.length<1||i.length<1||t.length<1||o.length<1||n.length<1){this._wizard.invalidateStep(this.byId("InvoiceReadingStep"))}else{this._wizard.validateStep(this.byId("InvoiceReadingStep"))}},onNavBack:function(){if(this._wizard.getProgressStep()!=this.byId("InvoiceUploadStep")){this._wizard.previousStep()}else{this.getOwnerComponent().getRouter().navTo("worklist",{})}},cancelWizard:function(){this._handleNavigationToStep(0);this._wizard.discardProgress(this._wizard.getSteps()[0]);this.getOwnerComponent().getRouter().navTo("worklist",{})},createRecord:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getView().getModel().getData();var t=e["To_InvoiceItems"];delete e["To_InvoiceItems"];var i=e;var n=false;i.DocNumber=i.DocNumber+"-"+Date.now();this.sendRequestCreate(t.length,i,t)},sendRequestCreate:function(e,t,n){var o=this;var r;var s;var c=t.DocNumber;if(a==0){r="/nsInvoiceSubmission/ProcurementService/browse/Invoice";s=t}else{r="/nsInvoiceSubmission/ProcurementService/browse/InvoiceItems";s=n[a-1];s.DocNumber_DocNumber=c}$.ajax({type:"POST",url:r,cache:false,data:JSON.stringify(s),dataType:"json",headers:{"Content-Type":"application/json;IEEE754Compatible=true"},async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a=0;i.show("An error has occured. Status: "+t)},success:function(i){if(e==a){a=0;o.uploadInvoicePDF(t.DocNumber)}else{a++;o.sendRequestCreate(e,t,n)}}})},uploadInvoicePDF:function(e){var t=this;var o=new FormData;o.append("file",c);o.append("cmisaction","createDocument");o.append("propertyId[0]","cmis:objectTypeId");o.append("propertyValue[0]","cmis:document");o.append("propertyId[1]","cmis:name");o.append("succinct","true");o.append("propertyValue[1]",e+".pdf");var r=new XMLHttpRequest;r.withCredentials=true;r.addEventListener("readystatechange",function(){if(this.readyState===4){if(this.status==201){i.show("A new invoice has been created.");t.cancelWizard()}else if(this.status==200){i.show("A new invoice has been created.")}else{var e=!!t.getView().$().closest(".sapUiSizeCompact").length;n.error("A new invoice has been created but we couldn't save the pdf file. Error: "+this.status,{styleClass:e?"sapUiSizeCompact":""})}sap.ui.core.BusyIndicator.hide()}});r.open("POST","/nsInvoiceSubmission/DocManagement/browser/<<Your Repository ID>>/root/Invoices");r.send(o)},optionalStepActivation:function(){i.show("This event is fired on activate of Step3.")},optionalStepCompletion:function(){i.show("This event is fired on complete of Step3. You can use it to gather the information, and lock the input data.")},pricingActivate:function(){this.model.setProperty("avApiEnabled",true)},pricingComplete:function(){this.model.setProperty("avApiEnabled",false)},scrollFrom4to2:function(){this._wizard.goToStep(this.byId("InvoiceInfoStep"))},goFrom4to3:function(){if(this._wizard.getProgressStep()===this.byId("PricingStep")){this._wizard.previousStep()}},goFrom4to5:function(){if(this._wizard.getProgressStep()===this.byId("PricingStep")){this._wizard.nextStep()}},wizardCompletedHandler:function(){this._oNavContainer.to(this._oWizardReviewPage)},backToWizardContent:function(){this._oNavContainer.backToPage(this._oWizardContentPage.getId())},editStepOne:function(){this._handleNavigationToStep(0)},editStepTwo:function(){this._handleNavigationToStep(1)},editStepThree:function(){this._handleNavigationToStep(2)},editStepFour:function(){this._handleNavigationToStep(3)},_handleNavigationToStep:function(e){var t=function(){this._wizard.goToStep(this._wizard.getSteps()[e]);this._oNavContainer.detachAfterNavigate(t)}.bind(this);this._oNavContainer.attachAfterNavigate(t);this.backToWizardContent()},_handleMessageBoxOpen:function(e,t){var i=this;n[t](e,{actions:[n.Action.YES,n.Action.NO],onClose:function(e){if(e===n.Action.YES){if(t=="warning")this.cancelWizard();else this.createRecord()}}.bind(this)})},_setEmptyValue:function(e){this.model.setProperty(e,"n/a")},handleWizardCancel:function(){this._handleMessageBoxOpen("Are you sure you want to cancel your invoice?","warning")},handleWizardSubmit:function(){this._handleMessageBoxOpen("Are you sure you want to create your invoice?","confirm")},productWeighStateFormatter:function(e){return isNaN(e)?"Error":"None"},discardProgress:function(){this._wizard.discardProgress(this.byId("InvoiceUploadStep"));var e=function(t){for(var i=0;i<t.length;i++){if(t[i].setValue){t[i].setValue("")}if(t[i].getContent){e(t[i].getContent())}}};this.model.setProperty("/productWeightState","Error");this.model.setProperty("/productNameState","Error");e(this._wizard.getSteps())}})});